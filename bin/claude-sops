#!/usr/bin/env bash
#
# claude-sops - Run Claude Code with SOPS-decrypted secrets as environment variables
#
# Usage: claude-sops [claude-args...]
#
# Configuration:
#   CLAUDE_SOPS_FILE - Path to encrypted secrets file (default: ~/.config/sops/secrets.yaml)
#   SOPS_AGE_KEY_FILE - Path to age key file (default: ~/.config/sops/age/keys.txt)
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration with defaults
AGE_KEY_FILE="${SOPS_AGE_KEY_FILE:-$HOME/.config/sops/age/keys.txt}"
SECRETS_FILE=""  # Set via discovery or --secrets flag

# Export for SOPS
export SOPS_AGE_KEY_FILE="$AGE_KEY_FILE"

log_error() {
    echo -e "${RED}Error:${NC} $1" >&2
}

log_warn() {
    echo -e "${YELLOW}Warning:${NC} $1" >&2
}

log_info() {
    echo -e "${GREEN}claude-sops:${NC} $1" >&2
}

# Track how secrets file was discovered (for --check output)
SECRETS_SOURCE=""

find_secrets_file() {
    # 1. Explicit override via env var always wins
    if [ -n "${CLAUDE_SOPS_FILE:-}" ] && [ -f "$CLAUDE_SOPS_FILE" ]; then
        SECRETS_SOURCE="from CLAUDE_SOPS_FILE env"
        echo "$CLAUDE_SOPS_FILE"
        return 0
    fi

    # 2. Walk up from current directory
    local dir="$PWD"
    local git_root=""

    # Find git root if in a repo
    if git rev-parse --git-dir &>/dev/null 2>&1; then
        git_root="$(git rev-parse --show-toplevel 2>/dev/null)"
    fi

    while [ "$dir" != "/" ]; do
        for candidate in \
            "$dir/secrets/infra.yaml" \
            "$dir/secrets/secrets.yaml" \
            "$dir/.secrets.yaml" \
            "$dir/secrets.yaml"; do
            if [ -f "$candidate" ]; then
                SECRETS_SOURCE="auto-discovered"
                echo "$candidate"
                return 0
            fi
        done

        # Stop at git root
        if [ -n "$git_root" ] && [ "$dir" = "$git_root" ]; then
            break
        fi

        dir="$(dirname "$dir")"
    done

    # 3. Fall back to global
    local global="$HOME/.config/sops/secrets.yaml"
    if [ -f "$global" ]; then
        SECRETS_SOURCE="global fallback"
        echo "$global"
        return 0
    fi

    return 1
}

check_dependencies() {
    local missing=()

    if ! command -v sops &> /dev/null; then
        missing+=("sops")
    fi

    if ! command -v age &> /dev/null; then
        missing+=("age")
    fi

    if ! command -v claude &> /dev/null; then
        missing+=("claude")
    fi

    if [ ${#missing[@]} -ne 0 ]; then
        log_error "Missing required dependencies: ${missing[*]}"
        echo ""
        echo "Install with:"
        echo "  brew install sops age    # macOS"
        echo "  apt install sops age     # Debian/Ubuntu"
        echo ""
        echo "For Claude Code:"
        echo "  npm install -g @anthropic-ai/claude-code"
        exit 1
    fi
}

check_age_key() {
    if [ ! -f "$AGE_KEY_FILE" ]; then
        log_error "Age key file not found: $AGE_KEY_FILE"
        echo ""
        echo "Generate a new age key with:"
        echo "  mkdir -p ~/.config/sops/age"
        echo "  age-keygen -o ~/.config/sops/age/keys.txt"
        echo ""
        echo "Or set SOPS_AGE_KEY_FILE to your key location."
        exit 1
    fi
}

validate_secrets() {
    # Quick validation that SOPS can decrypt the file
    if ! sops -d "$SECRETS_FILE" > /dev/null 2>&1; then
        log_error "Cannot decrypt secrets file: $SECRETS_FILE"
        echo ""
        echo "Possible causes:"
        echo "  - Your age key doesn't have access to this file"
        echo "  - The file is corrupted or not SOPS-encrypted"
        echo "  - Wrong SOPS_AGE_KEY_FILE path"
        exit 1
    fi
}

init_secrets() {
    log_info "Initializing secrets for this project..."
    echo ""

    # 1. Check/create age key
    if [ ! -f "$AGE_KEY_FILE" ]; then
        echo "No age key found at $AGE_KEY_FILE"
        read -p "Generate a new age key? [Y/n] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            mkdir -p "$(dirname "$AGE_KEY_FILE")"
            age-keygen -o "$AGE_KEY_FILE" 2>&1
            echo ""
            log_info "Age key created at $AGE_KEY_FILE"
        else
            log_error "Cannot continue without an age key"
            exit 1
        fi
    else
        log_info "Using existing age key: $AGE_KEY_FILE"
    fi

    # Get public key for .sops.yaml
    local public_key
    public_key=$(grep "public key:" "$AGE_KEY_FILE" | cut -d: -f2 | tr -d ' ')
    if [ -z "$public_key" ]; then
        public_key=$(age-keygen -y "$AGE_KEY_FILE" 2>/dev/null)
    fi

    # 2. Determine where to create secrets
    local git_root=""
    local target_dir="$PWD"
    local secrets_path=""

    if git rev-parse --git-dir &>/dev/null 2>&1; then
        git_root="$(git rev-parse --show-toplevel 2>/dev/null)"
        target_dir="$git_root"
    fi

    echo ""
    echo "Where should secrets be stored?"
    echo "  1) secrets/infra.yaml (recommended for projects)"
    echo "  2) .secrets.yaml (hidden in project root)"
    echo "  3) ~/.config/sops/secrets.yaml (global)"
    read -p "Choice [1]: " -n 1 -r choice
    echo

    case "${choice:-1}" in
        2) secrets_path="$target_dir/.secrets.yaml" ;;
        3) secrets_path="$HOME/.config/sops/secrets.yaml" ;;
        *) secrets_path="$target_dir/secrets/infra.yaml" ;;
    esac

    # 3. Create directory if needed
    local secrets_dir
    secrets_dir="$(dirname "$secrets_path")"
    if [ ! -d "$secrets_dir" ]; then
        mkdir -p "$secrets_dir"
        log_info "Created directory: $secrets_dir"
    fi

    # 4. Create .sops.yaml if it doesn't exist
    local sops_config="$secrets_dir/.sops.yaml"
    if [ ! -f "$sops_config" ]; then
        cat > "$sops_config" << EOF
# SOPS configuration
# Secrets encrypted with these keys can be decrypted by any of them
creation_rules:
  - path_regex: \.yaml$
    age: >-
      $public_key
EOF
        log_info "Created SOPS config: $sops_config"
    fi

    # 5. Check for template
    local template_file="$secrets_dir/$(basename "$secrets_path" .yaml).yaml.template"
    if [ -f "$template_file" ]; then
        echo ""
        log_info "Found template: $template_file"
        read -p "Use template as starting point? [Y/n] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            cp "$template_file" "$secrets_path"
            log_info "Copied template to $secrets_path"
        fi
    fi

    # 6. Create/edit secrets file
    echo ""

    # Run sops from the secrets directory so it finds .sops.yaml
    local original_dir="$PWD"
    cd "$secrets_dir" || exit 1
    local secrets_basename
    secrets_basename="$(basename "$secrets_path")"

    if [ -f "$secrets_basename" ]; then
        # Check if already encrypted (has sops metadata)
        if grep -q "sops:" "$secrets_basename" 2>/dev/null; then
            log_info "Opening encrypted file: $secrets_path"
            sops "$secrets_basename"
        else
            log_info "Encrypting and opening: $secrets_path"
            # Encrypt in place first, then open for editing
            sops -e -i "$secrets_basename"
            sops "$secrets_basename"
        fi
    else
        log_info "Creating new secrets file: $secrets_path"
        # Create minimal starter template
        cat > "$secrets_basename" << 'EOF'
# Add your secrets here (will be encrypted on save)
# Example:
# API_KEY: your-api-key-here
# DATABASE_URL: postgres://user:pass@host:5432/db

EOF
        sops -e -i "$secrets_basename"
        sops "$secrets_basename"
    fi

    cd "$original_dir" || exit 1

    # 7. Add to .gitignore if in a git repo
    if [ -n "$git_root" ]; then
        local gitignore="$secrets_dir/.gitignore"
        local secrets_basename
        secrets_basename="$(basename "$secrets_path")"
        if [ ! -f "$gitignore" ] || ! grep -q "^$secrets_basename$" "$gitignore" 2>/dev/null; then
            echo "$secrets_basename" >> "$gitignore"
            log_info "Added $secrets_basename to $gitignore"
        fi
    fi

    echo ""
    log_info "Setup complete!"
    echo ""
    echo "Your secrets file: $secrets_path"
    echo "Run 'claude-sops' to start Claude with these secrets loaded."
}

show_help() {
    cat << 'EOF'
claude-sops - Run Claude Code with SOPS-decrypted secrets

USAGE:
    claude-sops [OPTIONS] [-- claude-args...]

OPTIONS:
    -h, --help      Show this help message
    -v, --verbose   Show which secrets file is being used
    -c, --check     Validate setup without running Claude
    -i, --init      Interactive setup for new projects
    --upgrade       Update claude-sops to latest version
    --secrets FILE  Override secrets file path

SECRETS FILE DISCOVERY:
    claude-sops automatically finds your secrets file (first match wins):

    1. CLAUDE_SOPS_FILE environment variable (explicit override)
    2. --secrets FILE flag (explicit override)
    3. Project-local files (walks up from current directory to git root):
       - secrets/infra.yaml
       - secrets/secrets.yaml
       - .secrets.yaml
       - secrets.yaml
    4. Global fallback: ~/.config/sops/secrets.yaml

    Use --check to see which file is discovered.

ENVIRONMENT:
    CLAUDE_SOPS_FILE     Override secrets file path (highest priority)

    SOPS_AGE_KEY_FILE    Path to age private key
                         Default: ~/.config/sops/age/keys.txt

EXAMPLES:
    # Run Claude with auto-discovered secrets
    claude-sops

    # Run Claude in a specific directory
    claude-sops -- /path/to/project

    # Use a specific secrets file
    claude-sops --secrets ~/projects/myapp/secrets.yaml

    # Validate setup and see which file is used
    claude-sops --check

SETUP:
    1. Install dependencies:
       brew install sops age

    2. Generate age key:
       mkdir -p ~/.config/sops/age
       age-keygen -o ~/.config/sops/age/keys.txt

    3. Create and encrypt secrets (per-project or global):
       sops secrets/infra.yaml          # Project-local
       sops ~/.config/sops/secrets.yaml # Global fallback

    4. Run Claude with secrets:
       claude-sops

EOF
}

main() {
    local verbose=false
    local check_only=false
    local claude_args=()

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--verbose)
                verbose=true
                shift
                ;;
            -c|--check)
                check_only=true
                shift
                ;;
            -i|--init)
                check_dependencies
                init_secrets
                exit 0
                ;;
            --upgrade)
                log_info "Upgrading claude-sops..."
                local script_dir
                script_dir="$(dirname "$(readlink -f "$0")")"
                local repo_dir
                repo_dir="$(dirname "$script_dir")"
                if [ -d "$repo_dir/.git" ]; then
                    git -C "$repo_dir" pull
                    log_info "Upgraded successfully!"
                else
                    log_error "Not a git repo: $repo_dir"
                    echo "Reinstall with: curl -fsSL https://raw.githubusercontent.com/jordanburke/claude-sops/main/install.sh | bash"
                fi
                exit 0
                ;;
            --secrets)
                SECRETS_FILE="$2"
                SECRETS_SOURCE="from --secrets flag"
                shift 2
                ;;
            --)
                shift
                claude_args=("$@")
                break
                ;;
            *)
                claude_args+=("$1")
                shift
                ;;
        esac
    done

    # Run checks
    check_dependencies
    check_age_key

    # Determine secrets file (--secrets flag takes precedence, then discovery)
    if [ -z "${SECRETS_FILE:-}" ]; then
        SECRETS_FILE=$(find_secrets_file) || {
            log_error "No secrets file found"
            echo ""
            echo "Searched for:"
            echo "  - secrets/infra.yaml (in project)"
            echo "  - secrets/secrets.yaml (in project)"
            echo "  - .secrets.yaml (in project)"
            echo "  - secrets.yaml (in project)"
            echo "  - ~/.config/sops/secrets.yaml (global)"
            echo ""
            echo "Run 'claude-sops --init' for interactive setup"
            echo "Or create manually: sops secrets/infra.yaml"
            exit 1
        }
    fi

    validate_secrets

    if [ "$check_only" = true ]; then
        log_info "Setup validated successfully!"
        echo ""
        echo "Secrets file: $SECRETS_FILE ($SECRETS_SOURCE)"
        echo "Age key file: $AGE_KEY_FILE"
        echo ""
        echo "Available secrets (keys only):"
        sops -d --output-type dotenv "$SECRETS_FILE" 2>/dev/null | cut -d'=' -f1 | sed 's/^/  /'
        exit 0
    fi

    if [ "$verbose" = true ]; then
        log_info "Loading secrets from: $SECRETS_FILE"
    fi

    # Run Claude with decrypted secrets as environment variables
    exec sops exec-env "$SECRETS_FILE" "claude ${claude_args[*]}"
}

main "$@"

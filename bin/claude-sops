#!/usr/bin/env bash
#
# claude-sops - Run Claude Code with SOPS-decrypted secrets as environment variables
#
# Usage: claude-sops [claude-args...]
#
# Configuration:
#   CLAUDE_SOPS_FILE - Path to encrypted secrets file (default: ~/.config/sops/secrets.yaml)
#   SOPS_AGE_KEY_FILE - Path to age key file (default: ~/.config/sops/age/keys.txt)
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration with defaults
SECRETS_FILE="${CLAUDE_SOPS_FILE:-$HOME/.config/sops/secrets.yaml}"
AGE_KEY_FILE="${SOPS_AGE_KEY_FILE:-$HOME/.config/sops/age/keys.txt}"

# Export for SOPS
export SOPS_AGE_KEY_FILE="$AGE_KEY_FILE"

log_error() {
    echo -e "${RED}Error:${NC} $1" >&2
}

log_warn() {
    echo -e "${YELLOW}Warning:${NC} $1" >&2
}

log_info() {
    echo -e "${GREEN}claude-sops:${NC} $1" >&2
}

check_dependencies() {
    local missing=()

    if ! command -v sops &> /dev/null; then
        missing+=("sops")
    fi

    if ! command -v age &> /dev/null; then
        missing+=("age")
    fi

    if ! command -v claude &> /dev/null; then
        missing+=("claude")
    fi

    if [ ${#missing[@]} -ne 0 ]; then
        log_error "Missing required dependencies: ${missing[*]}"
        echo ""
        echo "Install with:"
        echo "  brew install sops age    # macOS"
        echo "  apt install sops age     # Debian/Ubuntu"
        echo ""
        echo "For Claude Code:"
        echo "  npm install -g @anthropic-ai/claude-code"
        exit 1
    fi
}

check_age_key() {
    if [ ! -f "$AGE_KEY_FILE" ]; then
        log_error "Age key file not found: $AGE_KEY_FILE"
        echo ""
        echo "Generate a new age key with:"
        echo "  mkdir -p ~/.config/sops/age"
        echo "  age-keygen -o ~/.config/sops/age/keys.txt"
        echo ""
        echo "Or set SOPS_AGE_KEY_FILE to your key location."
        exit 1
    fi
}

check_secrets_file() {
    if [ ! -f "$SECRETS_FILE" ]; then
        log_error "Secrets file not found: $SECRETS_FILE"
        echo ""
        echo "Create your secrets file and encrypt it with SOPS:"
        echo "  sops $SECRETS_FILE"
        echo ""
        echo "Or set CLAUDE_SOPS_FILE to your secrets location."
        exit 1
    fi
}

validate_secrets() {
    # Quick validation that SOPS can decrypt the file
    if ! sops -d "$SECRETS_FILE" > /dev/null 2>&1; then
        log_error "Cannot decrypt secrets file: $SECRETS_FILE"
        echo ""
        echo "Possible causes:"
        echo "  - Your age key doesn't have access to this file"
        echo "  - The file is corrupted or not SOPS-encrypted"
        echo "  - Wrong SOPS_AGE_KEY_FILE path"
        exit 1
    fi
}

show_help() {
    cat << 'EOF'
claude-sops - Run Claude Code with SOPS-decrypted secrets

USAGE:
    claude-sops [OPTIONS] [-- claude-args...]

OPTIONS:
    -h, --help      Show this help message
    -v, --verbose   Show which secrets file is being used
    -c, --check     Validate setup without running Claude
    --secrets FILE  Override secrets file path

ENVIRONMENT:
    CLAUDE_SOPS_FILE     Path to encrypted secrets file
                         Default: ~/.config/sops/secrets.yaml

    SOPS_AGE_KEY_FILE    Path to age private key
                         Default: ~/.config/sops/age/keys.txt

EXAMPLES:
    # Run Claude with secrets
    claude-sops

    # Run Claude in a specific directory
    claude-sops -- /path/to/project

    # Use a different secrets file
    claude-sops --secrets ~/projects/myapp/secrets.yaml

    # Validate setup
    claude-sops --check

SETUP:
    1. Install dependencies:
       brew install sops age

    2. Generate age key:
       mkdir -p ~/.config/sops/age
       age-keygen -o ~/.config/sops/age/keys.txt

    3. Create and encrypt secrets:
       sops ~/.config/sops/secrets.yaml

    4. Run Claude with secrets:
       claude-sops

EOF
}

main() {
    local verbose=false
    local check_only=false
    local claude_args=()

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--verbose)
                verbose=true
                shift
                ;;
            -c|--check)
                check_only=true
                shift
                ;;
            --secrets)
                SECRETS_FILE="$2"
                shift 2
                ;;
            --)
                shift
                claude_args=("$@")
                break
                ;;
            *)
                claude_args+=("$1")
                shift
                ;;
        esac
    done

    # Run checks
    check_dependencies
    check_age_key
    check_secrets_file
    validate_secrets

    if [ "$check_only" = true ]; then
        log_info "Setup validated successfully!"
        echo ""
        echo "Secrets file: $SECRETS_FILE"
        echo "Age key file: $AGE_KEY_FILE"
        echo ""
        echo "Available secrets (keys only):"
        sops -d --output-type dotenv "$SECRETS_FILE" 2>/dev/null | cut -d'=' -f1 | sed 's/^/  /'
        exit 0
    fi

    if [ "$verbose" = true ]; then
        log_info "Loading secrets from: $SECRETS_FILE"
    fi

    # Run Claude with decrypted secrets as environment variables
    exec sops exec-env "$SECRETS_FILE" "claude ${claude_args[*]}"
}

main "$@"
